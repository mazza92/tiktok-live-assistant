
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #44ff44;
            animation: none;
        }

        .status-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(360deg);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Entertainment Gauge */
        .entertainment-gauge {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-align: center;
        }

        .entertainment-gauge h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .entertainment-main {
            margin-bottom: 25px;
        }

        .score-display {
            margin-bottom: 20px;
        }

        .score-number {
            font-size: 4rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .score-label {
            font-size: 1.5rem;
            color: #FFD700;
            margin-top: 10px;
        }

        .progress-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .progress-markers {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #FFD93D, #6BCF7F);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .entertainment-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .breakdown-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .breakdown-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .breakdown-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .breakdown-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00E676;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-trend {
            margin-top: 10px;
            font-size: 1.2rem;
        }

        .metric-trend.increase {
            color: #4CAF50;
        }

        .metric-trend.decrease {
            color: #f44336;
        }

        .metric-trend.stable {
            color: #FF9800;
        }

        /* Activity and History Section */
        .activity-history {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .activity-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab-btn.active {
            background: #00E676;
            color: #333;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .activity-item, .feed-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #00E676;
            transition: all 0.3s ease;
        }

        .activity-item:hover, .feed-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .feed-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .feed-type-icon {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .feed-user {
            font-weight: bold;
            color: #FFD700;
        }

        .feed-time {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .feed-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .feed-sentiment {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .feed-sentiment.positive {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .feed-sentiment.negative {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .feed-sentiment.neutral {
            background: rgba(158, 158, 158, 0.3);
            color: #9E9E9E;
        }

        .activity-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-summary {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Gift Alert Overlay */
        .gift-alert-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid #FFD700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
        }

        .gift-alert-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .gift-alert-content {
            text-align: center;
        }

        .gift-alert-header {
            margin-bottom: 20px;
        }

        .gift-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .gift-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
        }

        .gift-alert-body {
            margin-bottom: 20px;
        }

        .gift-sender {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .gift-sender-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #FFD700;
        }

        .gift-sender-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .gift-details {
            margin-bottom: 15px;
        }

        .gift-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .gift-value {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .gift-alert-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .gift-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .shoutout-btn {
            background: #FF6B6B;
            color: white;
        }

        .thank-btn {
            background: #4CAF50;
            color: white;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .gift-action-btn:hover {
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .entertainment-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .entertainment-breakdown {
                grid-template-columns: 1fr;
            }
            
            .activity-tabs {
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <h1>🔴 TikTok Live Dashboard</h1>
    
    <!-- Connection Status -->
    <div class="connection-status">
        <div class="status-indicator" id="statusIndicator"></div>
        <span class="status-text" id="statusText">Connecting...</span>
        <button class="refresh-btn" onclick="manualReconnect()" id="refreshBtn" style="display: none;">🔄</button>
    </div>

    <div class="container">
        <!-- Entertainment Gauge -->
        <div class="entertainment-gauge">
            <h3>🔴 Live Mood Score</h3>
            
            <!-- Main Entertainment Score -->
            <div class="entertainment-main">
                <div class="score-display">
                    <div class="score-number" id="entertainmentScore">0</div>
                    <div class="score-label" id="entertainmentLabel">Neutral</div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-markers">
                        <div class="marker boring">😴</div>
                        <div class="marker meh">😐</div>
                        <div class="marker good">😊</div>
                        <div class="marker entertaining">🎉</div>
                        <div class="marker fire">🔥</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-labels">
                        <span>Boring</span>
                        <span>Meh</span>
                        <span>Good</span>
                        <span>Entertaining</span>
                        <span>Fire!</span>
                    </div>
                </div>
            </div>
            
            <!-- Entertainment Breakdown -->
            <div class="entertainment-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-icon">📊</div>
                    <div class="breakdown-label">Engagement</div>
                    <div class="breakdown-value" id="engagementScore">0.00</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-icon">💬</div>
                    <div class="breakdown-label">Content</div>
                    <div class="breakdown-value" id="contentScore">0.00</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-icon">⚡</div>
                    <div class="breakdown-label">Energy</div>
                    <div class="breakdown-value" id="energyScore">0.00</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-icon">👥</div>
                    <div class="breakdown-label">Retention</div>
                    <div class="breakdown-value" id="retentionScore">0.00</div>
                </div>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalLikes">0</div>
                <div class="metric-label">Total Likes</div>
                <div class="metric-trend" id="totalLikesTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="totalGifts">0</div>
                <div class="metric-label">Total Gifts</div>
                <div class="metric-trend" id="totalGiftsTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="likesPerMinute">0</div>
                <div class="metric-label">Likes per Minute</div>
                <div class="metric-trend" id="likesPerMinuteTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="totalShares">0</div>
                <div class="metric-label">Total Shares</div>
                <div class="metric-trend" id="totalSharesTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="totalComments">0</div>
                <div class="metric-label">Total Comments</div>
                <div class="metric-trend" id="totalCommentsTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="sentimentScore">0</div>
                <div class="metric-label">Sentiment</div>
                <div class="metric-trend" id="sentimentTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="followersGains">0</div>
                <div class="metric-label">New Followers</div>
                <div class="metric-trend" id="newFollowersTrend"></div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="viewerCount">0</div>
                <div class="metric-label">Live Viewers</div>
                <div class="metric-trend" id="viewerTrend"></div>
            </div>
        </div>

        <!-- Activity and History Section -->
        <div class="activity-history">
            <div class="activity-tabs">
                <button class="tab-btn active" onclick="switchActivityTab('all')">All</button>
                <button class="tab-btn" onclick="switchActivityTab('followers')">Followers</button>
                <button class="tab-btn" onclick="switchActivityTab('gifts')">Gifts</button>
            </div>
            <div class="activity-feed" id="activityFeed">
                <div class="activity-item waiting">Waiting for activity data...</div>
            </div>
            
            <!-- Activity Controls -->
            <div class="activity-controls">
                <div class="activity-summary">
                    <span id="activitySummary">No activity yet</span>
                </div>
                <button class="control-btn" onclick="toggleActivityPause()" id="pauseBtn">
                    ⏸️ Pause
                </button>
            </div>
        </div>
    </div>

    <!-- Gift Alert Overlay -->
    <div id="giftAlertOverlay" class="gift-alert-overlay hidden">
        <div class="gift-alert-content">
            <div class="gift-alert-header">
                <span class="gift-icon">🎁</span>
                <div class="gift-title">Gift Received!</div>
            </div>
            <div class="gift-alert-body">
                <div class="gift-sender">
                    <img id="giftSenderPic" class="gift-sender-pic" src="" alt="Profile Picture">
                    <span id="giftSenderName" class="gift-sender-name"></span>
                </div>
                <div class="gift-details">
                    <div class="gift-name" id="giftName"></div>
                    <div class="gift-value" id="giftValue"></div>
                </div>
            </div>
            <div class="gift-alert-actions">
                <button class="gift-action-btn shoutout-btn" onclick="generateShoutout()">🎤 Shoutout</button>
                <button class="gift-action-btn thank-btn" onclick="generateThankYou()">🙏 Thank You</button>
                <button class="gift-action-btn close-btn" onclick="closeGiftAlert()">✕</button>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 2000; // 2 seconds

        // Activity management variables
        let activityItems = [];
        let activityPaused = false;
        let currentActivityTab = 'all';
        let activityCounters = {
            comments: 0,
            likes: 0,
            gifts: 0,
            viewers: 0,
            totalLikes: 0,
            totalGifts: 0,
            followersGains: 0
        };

        function updateConnectionStatus(status, className) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const refreshBtn = document.getElementById('refreshBtn');
            
            indicator.className = `status-indicator ${className}`;
            text.textContent = status;
            
            // Show refresh button when disconnected or failed
            if (className === 'disconnected' || status.includes('Failed') || status.includes('Error')) {
                refreshBtn.style.display = 'inline-block';
            } else {
                refreshBtn.style.display = 'none';
            }
        }

        function connectWebSocket() {
            try {
                updateConnectionStatus('Connecting...', '');
                ws = new WebSocket('ws://localhost:3000');
                
                ws.onopen = function() {
                    console.log('🖥️  Dashboard connected via WebSocket');
                    updateConnectionStatus('Connected', 'connected');
                    reconnectAttempts = 0; // Reset reconnect attempts on successful connection
                    
                    // Send test message to verify connection
                    ws.send(JSON.stringify({ type: 'test', data: 'ping' }));
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('📨 Received message:', message.type);
                        
                        switch (message.type) {
                            case 'metrics':
                                console.log('📊 [WEBSOCKET] Metrics received:', message.data);
                                updateMetrics(message.data);
                                break;
                            case 'chat':
                                console.log('💬 Chat message:', message.data);
                                addActivityItem('💬', message.data.nickname, message.data.comment, message.data.sentimentScore, message.data.timestamp);
                                break;
                            case 'like':
                                console.log('❤️ Like event:', message.data);
                                const likeText = message.data.likeCount > 1 ? 
                                    `sent ${message.data.likeCount} likes` : 
                                    'sent a like';
                                addActivityItem('❤️', message.data.nickname, likeText, null, message.data.timestamp);
                                break;
                            case 'gift':
                                console.log('🎁 Gift event:', message.data);
                                const giftName = message.data.gift?.name || message.data.giftName || 'Unknown Gift';
                                const diamondCount = message.data.gift?.diamondCount || message.data.diamondCount || 'unknown';
                                addActivityItem('🎁', message.data.nickname, `sent ${giftName} (${diamondCount} diamonds)`, null, message.data.timestamp);
                                
                                // Show gift alert overlay
                                showGiftAlert(message.data);
                                break;
                            case 'share':
                                console.log('📤 Share event:', message.data);
                                const shareText = message.data.shareCount > 1 ? 
                                    `shared ${message.data.shareCount} times` : 
                                    'shared the stream';
                                addActivityItem('📤', message.data.nickname, shareText, null, message.data.timestamp);
                                break;
                            case 'viewerCount':
                                console.log('👥 Viewer count update:', message.data);
                                updateViewerCount(message.data.count);
                                break;
                            case 'newFollower':
                                console.log('🆕 New follower:', message.data);
                                addActivityItem('🆕', message.data.nickname, 'started following!', null, message.data.timestamp);
                                break;
                            default:
                                console.log('📨 Unknown message type:', message.type);
                        }
                    } catch (error) {
                        console.error('❌ Error parsing message:', error);
                    }
                };
                
                ws.onclose = function() {
                    console.log('❌ WebSocket connection closed');
                    updateConnectionStatus('Disconnected', 'disconnected');
                    attemptReconnect();
                };
                
                ws.onerror = function(error) {
                    console.error('❌ WebSocket error:', error);
                    updateConnectionStatus('Connection Error', 'disconnected');
                };
                
            } catch (error) {
                console.error('❌ Failed to connect WebSocket:', error);
                updateConnectionStatus('Failed to Connect', 'disconnected');
                attemptReconnect();
            }
        }

        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                updateConnectionStatus(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`, '');
                setTimeout(connectWebSocket, reconnectDelay);
            } else {
                updateConnectionStatus('Connection Failed', 'disconnected');
            }
        }

        function manualReconnect() {
            reconnectAttempts = 0;
            connectWebSocket();
        }

        // Update metrics display
        function updateMetrics(data) {
            console.log('📊 [DASHBOARD] Updating metrics:', data);
            
            // Update entertainment score and breakdown
            if (data.entertainmentMetrics) {
                updateEntertainmentScore(data.entertainmentMetrics.entertainmentScore, data.entertainmentMetrics);
            }
            
            // Update metrics
            const elements = {
                totalLikes: data.totalLikes,
                totalGifts: data.totalGifts,
                totalComments: data.totalComments,
                totalShares: data.totalShares,
                likesPerMinute: data.likesPerMinute,
                sentimentScore: data.sentimentScore,
                followersGains: data.sessionFollowersGained,
                viewerCount: data.currentViewerCount
            };
            
            Object.entries(elements).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element && value !== undefined) {
                    element.textContent = typeof value === 'number' ? value.toLocaleString() : value;
                }
            });
        }

        // Update entertainment score display
        function updateEntertainmentScore(score, breakdown) {
            const scoreElement = document.getElementById('entertainmentScore');
            const labelElement = document.getElementById('entertainmentLabel');
            const progressFill = document.getElementById('progressFill');
            
            if (!scoreElement || !labelElement || !progressFill) return;
            
            // Update score
            scoreElement.textContent = Math.round(score);
            
            // Update label based on score
            let label = 'Neutral';
            if (score >= 80) label = 'Fire! 🔥';
            else if (score >= 60) label = 'Entertaining 🎉';
            else if (score >= 40) label = 'Good 😊';
            else if (score >= 20) label = 'Meh 😐';
            else label = 'Boring 😴';
            
            labelElement.textContent = label;
            
            // Update progress bar
            const percentage = Math.min(100, Math.max(0, score));
            progressFill.style.width = percentage + '%';
            
            // Update breakdown if provided
            if (breakdown) {
                updateEntertainmentBreakdown(breakdown);
            }
        }

        // Update entertainment breakdown
        function updateEntertainmentBreakdown(breakdown) {
            if (breakdown) {
                const engagementScore = document.getElementById('engagementScore');
                const contentScore = document.getElementById('contentScore');
                const energyScore = document.getElementById('energyScore');
                const retentionScore = document.getElementById('retentionScore');
                
                if (engagementScore && breakdown.engagementIntensity !== undefined) {
                    engagementScore.textContent = (breakdown.engagementIntensity * 100).toFixed(0) + '%';
                }
                if (contentScore && breakdown.contentReception !== undefined) {
                    contentScore.textContent = (breakdown.contentReception * 100).toFixed(0) + '%';
                }
                if (energyScore && breakdown.audienceEnergy !== undefined) {
                    energyScore.textContent = (breakdown.audienceEnergy * 100).toFixed(0) + '%';
                }
                if (retentionScore && breakdown.retentionQuality !== undefined) {
                    retentionScore.textContent = (breakdown.retentionQuality * 100).toFixed(0) + '%';
                }
            }
        }

        // Update viewer count
        function updateViewerCount(count) {
            const viewerElement = document.getElementById('viewerCount');
            if (viewerElement) {
                viewerElement.textContent = count.toLocaleString();
            }
        }

        // Activity management
        function addActivityItem(icon, nickname, content, sentiment = null, timestamp = null) {
            if (activityPaused) return;
            
            const activityItem = {
                id: Date.now() + Math.random(),
                icon: icon,
                nickname: nickname,
                content: content,
                sentiment: sentiment,
                timestamp: timestamp || new Date(),
                type: getActivityType(icon)
            };
            
            activityItems.unshift(activityItem);
            updateActivityDisplay();
            updateActivityCounters(activityItem.type);
        }

        function getActivityType(icon) {
            if (icon === '💬') return 'comment';
            if (icon === '❤️') return 'like';
            if (icon === '🎁') return 'gift';
            if (icon === '📤') return 'share';
            if (icon === '👥') return 'viewer';
            if (icon === '🆕') return 'follower';
            return 'other';
        }

        function updateActivityDisplay() {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) return;
            
            // Filter by current tab
            let filteredItems = activityItems;
            
            if (currentActivityTab !== 'all') {
                filteredItems = activityItems.filter(item => {
                    if (currentActivityTab === 'followers') return item.type === 'follower';
                    if (currentActivityTab === 'gifts') return item.type === 'gift';
                    return true;
                });
            }
            
            // Clear and rebuild
            activityFeed.innerHTML = '';
            
            if (filteredItems.length === 0) {
                activityFeed.innerHTML = '<div class="activity-item">No activity to display...</div>';
                return;
            }
            
            filteredItems.slice(0, 50).forEach((item) => {
                const feedItem = document.createElement('div');
                feedItem.className = 'feed-item';
                
                const timeAgo = getTimeAgo(item.timestamp);
                const sentimentClass = item.sentiment !== null ? getSentimentClass(item.sentiment) : '';
                
                feedItem.innerHTML = `
                    <div class="feed-header-row">
                        <span class="feed-type-icon">${item.icon}</span>
                        <span class="feed-user">${item.nickname}</span>
                        <span class="feed-time" data-timestamp="${item.timestamp.toISOString()}">${timeAgo}</span>
                        ${item.sentiment !== null ? `<span class="feed-sentiment ${sentimentClass}">${getSentimentText(item.sentiment)}</span>` : ''}
                    </div>
                    <div class="feed-content">${item.content}</div>
                `;
                
                feedItem.setAttribute('data-type', item.type);
                activityFeed.appendChild(feedItem);
            });
        }

        function switchActivityTab(tab) {
            currentActivityTab = tab;
            
            // Update tab button states
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateActivityDisplay();
        }

        function toggleActivityPause() {
            activityPaused = !activityPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = activityPaused ? '▶️ Resume' : '⏸️ Pause';
        }

        function updateActivityCounters(type) {
            if (type === 'comment') activityCounters.comments++;
            else if (type === 'like') activityCounters.likes++;
            else if (type === 'gift') activityCounters.gifts++;
            else if (type === 'follower') activityCounters.followersGains++;
            
            updateActivitySummary();
        }

        function updateActivitySummary() {
            const summary = document.getElementById('activitySummary');
            if (summary) {
                summary.textContent = `💬 ${activityCounters.comments} | ❤️ ${activityCounters.likes} | 🎁 ${activityCounters.gifts} | 🆕 ${activityCounters.followersGains}`;
            }
        }

        // Gift alert functions
        function showGiftAlert(giftData) {
            const overlay = document.getElementById('giftAlertOverlay');
            const senderPic = document.getElementById('giftSenderPic');
            const senderName = document.getElementById('giftSenderName');
            const giftName = document.getElementById('giftName');
            const giftValue = document.getElementById('giftValue');
            
            if (giftData.profilePic) {
                senderPic.src = giftData.profilePic;
                senderPic.style.display = 'block';
            } else {
                senderPic.style.display = 'none';
            }
            
            senderName.textContent = giftData.nickname || 'Anonymous';
            giftName.textContent = giftData.gift?.name || giftData.giftName || 'Unknown Gift';
            giftValue.textContent = `${giftData.gift?.diamondCount || giftData.diamondCount || 0} diamonds`;
            
            overlay.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                closeGiftAlert();
            }, 5000);
        }

        function closeGiftAlert() {
            const overlay = document.getElementById('giftAlertOverlay');
            overlay.classList.add('hidden');
        }

        function generateShoutout() {
            console.log('🎤 Generating shoutout...');
            closeGiftAlert();
        }

        function generateThankYou() {
            console.log('🙏 Generating thank you...');
            closeGiftAlert();
        }

        // Utility functions
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        function getSentimentClass(sentiment) {
            if (sentiment > 0.1) return 'positive';
            if (sentiment < -0.1) return 'negative';
            return 'neutral';
        }

        function getSentimentText(sentiment) {
            if (sentiment > 0.1) return 'Positive';
            if (sentiment < -0.1) return 'Negative';
            return 'Neutral';
        }

        // Initialize connection on page load
        window.addEventListener('load', function() {
            console.log('🖥️  Dashboard initializing...');
            connectWebSocket();
        });
    </script>
</body>
</html>
